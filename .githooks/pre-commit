#!/bin/bash

# Pre-commit hook for Triathlon Race Scheduler
# Prevents commits with compilation errors, type errors, or test failures

set -e

echo "ğŸ” Running pre-commit validation..."

# Check if we're in the right directory
if [ ! -f "package.json" ] && [ ! -d "frontend" ]; then
    echo "âŒ Not in project root directory"
    exit 1
fi

# Frontend validation
if [ -d "frontend" ]; then
    echo "ğŸ“‹ Validating frontend..."
    cd frontend
    
    # Check if node_modules exists
    if [ ! -d "node_modules" ]; then
        echo "ğŸ“¦ Installing frontend dependencies..."
        npm install
    fi
    
    # TypeScript type checking
    echo "ğŸ” Running TypeScript type checking..."
    if ! npx tsc --noEmit --skipLibCheck; then
        echo "âŒ TypeScript type checking failed"
        exit 1
    fi
    
    # Build test (ensures no compilation errors)
    echo "ğŸ—ï¸ Testing build compilation..."
    if ! npm run build > /dev/null 2>&1; then
        echo "âŒ Build compilation failed"
        echo "Run 'cd frontend && npm run build' to see detailed errors"
        exit 1
    fi
    
    # Run tests
    echo "ğŸ§ª Running tests..."
    if ! npm test > /dev/null 2>&1; then
        echo "âŒ Tests failed"
        echo "Run 'cd frontend && npm test' to see detailed errors"
        exit 1
    fi
    
    cd ..
fi

# Backend validation
if [ -d "backend" ]; then
    echo "ğŸ“‹ Validating backend..."
    cd backend
    
    # Check if node_modules exists
    if [ ! -d "node_modules" ]; then
        echo "ğŸ“¦ Installing backend dependencies..."
        npm install
    fi
    
    # Basic syntax check
    echo "ğŸ” Checking backend syntax..."
    if ! node -c server.js; then
        echo "âŒ Backend syntax check failed"
        exit 1
    fi
    
    cd ..
fi

echo "âœ… All validation checks passed!"
echo "ğŸš€ Commit is ready to proceed."
